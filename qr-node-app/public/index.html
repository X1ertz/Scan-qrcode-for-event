<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan QR Code</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <style>
    #result.found { color: green; font-weight: bold; }
    #result.not-found { color: red; font-weight: bold; }
    #reader { width: 400px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Scan QR Code</h1>
    <p>Scan to check your attendance</p>
  </header>

  <div id="reader"></div>

  <div id="controls">
    <label>Camera: </label>
    <select id="cameraSelect"></select>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
  </div>

  <div id="result">No result</div>

  <script>
    let html5QrcodeScanner = null;
    let currentCameraId = null;

    async function checkHash(hash) {
      try {
        const res = await fetch("/api/check-hash", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hash })
        });
        const data = await res.json();
        const resultDiv = document.getElementById("result");
        if (data.found) {
          resultDiv.className = "found";
          resultDiv.innerHTML = `<span style="font-size:1.5rem">${data.message}</span>`;
        } else {
          resultDiv.className = "not-found";
          resultDiv.innerHTML = "-";
        }
      } catch (err) {
        console.error(err);
        const resultDiv = document.getElementById("result");
        resultDiv.className = "not-found";
        resultDiv.innerHTML = "เกิดข้อผิดพลาด";
      }
    }

    function onScanSuccess(decodedText) {
      console.log("Scanned:", decodedText);
      checkHash(decodedText);
    }

    function onScanFailure(error) {
      // console.warn(error);
    }

    // ดึงกล้องทั้งหมด
    Html5Qrcode.getCameras().then(cameras => {
      const select = document.getElementById("cameraSelect");
      cameras.forEach(cam => {
        const option = document.createElement("option");
        option.value = cam.id;
        option.text = cam.label || cam.id;
        select.appendChild(option);
      });
      if(cameras.length > 0) currentCameraId = cameras[0].id;
    }).catch(err => console.error("Cannot get cameras:", err));

    // เลือกกล้อง
    document.getElementById("cameraSelect").addEventListener("change", async (e) => {
      currentCameraId = e.target.value;
      if(html5QrcodeScanner) {
        await html5QrcodeScanner.stop();
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
      }
    });

    // ปุ่ม start
    document.getElementById("startBtn").addEventListener("click", async () => {
      if(!currentCameraId) return alert("No camera selected");
      if(!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader");
      html5QrcodeScanner.start(
        currentCameraId,
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanFailure
      ).catch(err => console.error("Start failed:", err));
    });

    // ปุ่ม stop
    document.getElementById("stopBtn").addEventListener("click", async () => {
      if(html5QrcodeScanner) {
        await html5QrcodeScanner.stop().catch(err => console.error(err));
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
        console.log("Scanner stopped");
      }
    });
  </script>
</body>
</html>
